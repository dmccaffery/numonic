#! /usr/bin/env sh

set -e

__numonic_git_commit_mark() {
	message="[MARK]"

	while :; do
		case $1 in
			-d|--debug)
				debug=1
				;;
			-h|--help)
				man git-commit-mark
				return 0
				;;
			-q|--quiet)
				quiet=1
				;;
			-m|--message)
				message="[MARK] ${2}"
				shift
				;;
			--message=*)
				message="[MARK] ${1#*=}"
				;;
			*?)
				if [ "${message}" = "[MARK]" ]; then
					message="[MARK] ${1}"
				else
					print-fail "git commit-mark: too many arguments, argument: ${1} is unexpected"
					man git-commit-mark | cat 1>&2
					return 1
				fi
				;;
			*)
				break;
		esac
		shift
	done

	(
		if [ -n "${quiet:-}" ]; then
			exec 1>/dev/null
		fi

		if [ -n "${debug:-}" ]; then
			set -x
		fi

		if git stash --only-untracked --message='[MARK]' 2>/dev/null; then
			stashed=1
		fi

		git reset
		git commit --allow-empty --message "${message}" --signoff
		git add --all

		if [ -n "${stashed:-}" ]; then
			git stash pop
		fi
	)
}

__numonic_git_commit_mark "$@"
